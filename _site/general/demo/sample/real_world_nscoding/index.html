<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Real World NSCoding &#8211; Luke Deniston</title>
<meta name="description" content="The code the project needs, but not the one it deserves">
<meta name="keywords" content="demo, dbyll, dbtek, sample2">


<meta property="og:locale" content="en_US">
<meta property="og:title" content="Real World NSCoding &#8211; Luke Deniston">
<meta property="og:description" content="The code the project needs, but not the one it deserves">
<meta property="og:url" content="/general/demo/sample/real_world_nscoding">
<meta property="og:site_name" content="Luke Deniston">


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Luke Deniston Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Crimson+Text:400,400italic,700,700italic" rel='stylesheet' type='text/css' />
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/css/entypo.css" media="all">
<link rel="stylesheet" href="/assets/css/syntax.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">Luke Deniston</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/" title="Luke Deniston">Home</a>
            </li>
            
            
                <li><a href="/about" >About</a></li>
            
                <li><a href="http://re.vu/Luke.Deniston" >Resumé</a></li>
            

          </ul>
        </nav>
      </div>
    </header>


<section class="article">


  <div class="overlay"></div>
  <div class="featured-image" style="background-image: url(/images/typewriter.jpg)"></div>



      <article class="wrap post">
        <header class="post-header">
          <hgroup>
            <h1>Real World NSCoding</h1>
            <p class="date">Nov 14, 2013</p>
            <p class="intro">The code the project needs, but not the one it deserves</p>
          </hgroup>
        </header>

        <p>In the hillarious and painfully accurate article <a href='http://stilldrinking.org/programming-sucks'>Programming Sucks</a>, Peter Welch said this:</p>

<blockquote>
<p>Every programmer occasionally&#8230;opens up a file on their computer&#8230;This file is Good Code. It has sensible and consistent names for functions and variables. It&#8217;s concise. It doesn&#8217;t do anything obviously stupid. It has never had to live in the wild, or answer to a sales team&#8230;</p>
</blockquote>

<blockquote>
<p>Every programmer starts out writing some perfect little snowflake like this. Then they&#8217;re told on Friday they need to have six hundred snowflakes written by Tuesday, so they cheat a bit here and there and maybe copy a few snowflakes and try to stick them together or they have to ask a coworker to work on one who melts it and then all the programmers&#8217; snowflakes get dumped together in some inscrutable shape&#8230;</p>
</blockquote>

<p>The code in this article is not Good Code. In some places, it is in fact, Bad Code. There were opportunities to avoid this code, but sometimes sales teams and deadlines make Bad Code the Right Code for the problem. That&#8217;s why this article is titled &#8220;Real World NSCoding&#8221;.</p>

<h2 id='the_problem'>The Problem</h2>

<p>I was recently brought in to help finish up a project that was essentially a large form. This wasn&#8217;t a simple sign up form however, this was a form that rivaled a small business tax preparation (and with all the fun liability implications too!). One of the features that hadn&#8217;t been implemented yet was the ability to save an incomplete form, and come back to it later by picking it from a list of forms.</p>

<p>Had the form been backed by something like a CoreData object, this would have been easy, but instead it was a class with hundreds of properties, and many of those properties were classes with hundreds of properties.</p>

<h2 id='nscoding_to_the_rescue'>NSCoding To The Rescue</h2>

<p>If you&#8217;re looking for an introduction to the subject, <a href='http://nshipster.com/nscoding/'>NSHipster&#8217;s article on NSCoding</a> is a great place to start. For the unfamiliar, <a href='https://developer.apple.com/library/ios/documentation/cocoa/reference/foundation/Protocols/NSCoding_Protocol/Reference/Reference.html'>NSCoding</a> is a protocol that defines only two methods: <code>encodeWithCoder:</code> and <code>initWithCoder:</code>. NSCoding by itself isn&#8217;t that interesting, but paired with <a href='https://developer.apple.com/library/ios/Documentation/Cocoa/Reference/Foundation/Classes/NSKeyedArchiver_Class/Reference/Reference.html'>NSKeyedArchiver</a>/<a href='https://developer.apple.com/library/ios/Documentation/Cocoa/Reference/Foundation/Classes/NSKeyedUnarchiver_Class/Reference/Reference.html#//apple_ref/occ/cl/NSKeyedUnarchiver'>NSKeyedUnarchiver</a> you get a powerful and flexible way to persist arbitrary data objects to the file system.</p>

<p>My problem was that it would be too time consuming at this point to go back and manually implement <code>encodeWithCoder:</code> and <code>initWithCoder:</code> on the dozens of classes used in the feature, and doing so would create a brittleness that would be hard to detect. I wanted to avoid situations where a developer added an NSString property to class, only to find out later that it needed to also be added to the NSCoding methods in order to be persisted.</p>

<p>Fortunately, the dynamic nature of the Objective-C runtime gave me some introspection tools that I could leverage to make things relatively painless.</p>

<h2 id='the_solution'>The Solution</h2>

<p>I&#8217;ve had this method kicking around for a while (origins unknown). It&#8217;s in a category for NSObject. Don&#8217;t forget to <code>#import &lt;objc/runtime.h&gt;</code>:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='n'>NSMutableDictionary</span> <span class='o'>*</span><span class='p'>)</span><span class='nf'>toDictionary</span> <span class='p'>{</span>
    <span class='n'>NSMutableDictionary</span> <span class='o'>*</span><span class='n'>props</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>NSMutableDictionary</span> <span class='n'>dictionary</span><span class='p'>];</span>
    <span class='kt'>unsigned</span> <span class='kt'>int</span> <span class='n'>outCount</span><span class='p'>,</span> <span class='n'>i</span><span class='p'>;</span>
    <span class='kt'>objc_property_t</span> <span class='o'>*</span><span class='n'>properties</span> <span class='o'>=</span> <span class='n'>class_copyPropertyList</span><span class='p'>([</span><span class='n'>self</span> <span class='n'>class</span><span class='p'>],</span> <span class='o'>&amp;</span><span class='n'>outCount</span><span class='p'>);</span>
    <span class='k'>for</span> <span class='p'>(</span><span class='n'>i</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span> <span class='n'>i</span> <span class='o'>&lt;</span> <span class='n'>outCount</span><span class='p'>;</span> <span class='n'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kt'>objc_property_t</span> <span class='n'>property</span> <span class='o'>=</span> <span class='n'>properties</span><span class='p'>[</span><span class='n'>i</span><span class='p'>];</span>
        <span class='n'>NSString</span> <span class='o'>*</span><span class='n'>propertyName</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>NSString</span> <span class='n'>stringWithFormat</span><span class='o'>:</span><span class='s'>@&quot;%s&quot;</span><span class='p'>,</span> <span class='n'>property_getName</span><span class='p'>(</span><span class='n'>property</span><span class='p'>)];</span>
        <span class='kt'>id</span> <span class='n'>propertyValue</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>self</span> <span class='n'>valueForKey</span><span class='o'>:</span><span class='p'>(</span><span class='n'>NSString</span> <span class='o'>*</span><span class='p'>)</span><span class='n'>propertyName</span><span class='p'>];</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='n'>propertyValue</span><span class='p'>)</span> <span class='p'>{</span>
            <span class='p'>[</span><span class='n'>props</span> <span class='n'>setObject</span><span class='o'>:</span><span class='n'>propertyValue</span> <span class='n'>forKey</span><span class='o'>:</span><span class='n'>propertyName</span><span class='p'>];</span>
        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
            <span class='p'>[</span><span class='n'>props</span> <span class='n'>setObject</span><span class='o'>:</span><span class='p'>[</span><span class='n'>NSNull</span> <span class='n'>null</span><span class='p'>]</span> <span class='n'>forKey</span><span class='o'>:</span><span class='n'>propertyName</span><span class='p'>];</span>
        <span class='p'>}</span>
    <span class='p'>}</span>
    <span class='n'>free</span><span class='p'>(</span><span class='n'>properties</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='n'>props</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>This give us a nice NSDictionary representation of any NSObject. I made another category method that levies this dictionary to encode the object:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='kt'>void</span><span class='p'>)</span><span class='nf'>LJD_encodeWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>aCoder</span> <span class='p'>{</span>
    <span class='n'>NSMutableDictionary</span> <span class='o'>*</span><span class='n'>selfDictionary</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>self</span> <span class='n'>toDictionary</span><span class='p'>];</span>
    <span class='k'>for</span> <span class='p'>(</span><span class='kt'>id</span> <span class='n'>key</span> <span class='k'>in</span> <span class='n'>selfDictionary</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>if</span> <span class='p'>([</span><span class='n'>selfDictionary</span><span class='p'>[</span><span class='n'>key</span><span class='p'>]</span> <span class='n'>conformsToProtocol</span><span class='o'>:</span><span class='err'>@</span><span class='n'>protocol</span><span class='p'>(</span><span class='n'>NSCoding</span><span class='p'>)])</span> <span class='p'>{</span>
            <span class='p'>[</span><span class='n'>aCoder</span> <span class='n'>encodeObject</span><span class='o'>:</span><span class='n'>selfDictionary</span><span class='p'>[</span><span class='n'>key</span><span class='p'>]</span> <span class='n'>forKey</span><span class='o'>:</span><span class='n'>key</span><span class='p'>];</span>
        <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
            <span class='c1'>// For debugging</span>
            <span class='n'>NSLog</span><span class='p'>(</span><span class='s'>@&quot;Non NSCoding: %@&quot;</span><span class='p'>,</span> <span class='n'>key</span><span class='p'>);</span>
        <span class='p'>}</span>
    <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
<p>Then for each class I need to persist, I simply declare that they conform to the <code>NSCoding</code> protocol and add the following method:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='kt'>void</span><span class='p'>)</span><span class='nf'>encodeWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>aCoder</span><span class='p'>{</span>
    <span class='p'>[</span><span class='n'>self</span> <span class='n'>LJD_encodeWithCoder</span><span class='o'>:</span><span class='n'>aCoder</span><span class='p'>];</span>
<span class='p'>}</span>
</code></pre></div>
<p>While there are other more &#8220;magical&#8221; ways to accomplish this (overriding methods, swizzling, custom protocols), sometimes a <em>little bit</em> of boilerplate makes it easer for developers down the line to follow what&#8217;s happening.</p>

<h2 id='the_code_the_project_needs_but_not_the_one_it_deserves'>The Code The Project Needs, But Not The One It Deserves</h2>

<p>So far so good, right? Get a dictionary. Encode it. Easy. Now we just need to decode it.</p>

<p>Here&#8217;s where it get&#8217;s a little gross. Here&#8217;s the full, production method for you to take in (note that <code>VLog</code> is a macro that does some fun things with <code>NSLog</code> if DEBUG is defined). From that same NSObject category:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='kt'>id</span><span class='p'>)</span><span class='nf'>LJD_initWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>aDecoder</span><span class='p'>{</span>
    <span class='n'>NSMutableDictionary</span> <span class='o'>*</span><span class='n'>selfDict</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>self</span> <span class='n'>toDictionary</span><span class='p'>];</span>
    <span class='n'>VLog</span><span class='p'>(</span><span class='s'>@&quot;Decoding a %@&quot;</span><span class='p'>,</span> <span class='n'>NSStringFromClass</span><span class='p'>([</span><span class='n'>self</span> <span class='n'>class</span><span class='p'>])</span> <span class='p'>);</span>
    <span class='k'>for</span> <span class='p'>(</span><span class='n'>NSString</span> <span class='o'>*</span><span class='n'>key</span> <span class='k'>in</span> <span class='n'>selfDict</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='p'>[</span><span class='n'>aDecoder</span> <span class='n'>containsValueForKey</span><span class='o'>:</span><span class='n'>key</span><span class='p'>])</span> <span class='p'>{</span>
            <span class='n'>VLog</span><span class='p'>(</span><span class='s'>@&quot;Warning: Did not find value for &#39;%@&#39;&quot;</span><span class='p'>,</span> <span class='n'>key</span><span class='p'>);</span>
            <span class='k'>continue</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>@try</span> <span class='p'>{</span>
            <span class='kt'>id</span> <span class='n'>value</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>aDecoder</span> <span class='n'>decodeObjectForKey</span><span class='o'>:</span><span class='n'>key</span><span class='p'>];</span>
            
<span class='cp'>#ifdef DEBUG</span>
            <span class='c1'>// For Debugging/Logging</span>
            <span class='n'>NSString</span> <span class='o'>*</span><span class='n'>stringValue</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>NSString</span> <span class='n'>stringWithFormat</span><span class='o'>:</span><span class='s'>@&quot;%@&quot;</span><span class='p'>,</span> <span class='n'>value</span><span class='p'>];</span>
            <span class='n'>NSString</span> <span class='o'>*</span><span class='n'>shortValue</span> <span class='o'>=</span> <span class='p'>([</span><span class='n'>stringValue</span> <span class='n'>length</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='mi'>10</span> <span class='o'>?</span> <span class='p'>[</span><span class='n'>NSString</span> <span class='n'>stringWithFormat</span><span class='o'>:</span><span class='s'>@&quot;%@...&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>stringValue</span> <span class='n'>substringToIndex</span><span class='o'>:</span><span class='mi'>10</span><span class='p'>]]</span> <span class='o'>:</span> <span class='n'>stringValue</span><span class='p'>);</span>
<span class='cp'>#endif</span>

            <span class='n'>NSString</span> <span class='o'>*</span><span class='n'>selectorName</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>NSString</span> <span class='n'>stringWithFormat</span><span class='o'>:</span><span class='s'>@&quot;set%@:&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>key</span> <span class='n'>stringByReplacingCharactersInRange</span><span class='o'>:</span><span class='n'>NSMakeRange</span><span class='p'>(</span><span class='mi'>0</span><span class='p'>,</span><span class='mi'>1</span><span class='p'>)</span> <span class='n'>withString</span><span class='o'>:</span><span class='p'>[[</span><span class='n'>key</span> <span class='n'>substringToIndex</span><span class='o'>:</span><span class='mi'>1</span><span class='p'>]</span> <span class='n'>capitalizedString</span><span class='p'>]]];</span>

            <span class='k'>if</span> <span class='p'>(</span><span class='n'>value</span> <span class='o'>&amp;&amp;</span> <span class='n'>value</span> <span class='o'>!=</span> <span class='p'>[</span><span class='n'>NSNull</span> <span class='n'>null</span><span class='p'>]</span> <span class='o'>&amp;&amp;</span> <span class='p'>[</span><span class='n'>self</span> <span class='n'>respondsToSelector</span><span class='o'>:</span><span class='n'>NSSelectorFromString</span><span class='p'>(</span><span class='n'>selectorName</span><span class='p'>)])</span> <span class='p'>{</span>
                <span class='p'>[</span><span class='n'>self</span> <span class='n'>setValue</span><span class='o'>:</span><span class='n'>value</span> <span class='n'>forKeyPath</span><span class='o'>:</span><span class='n'>key</span><span class='p'>];</span>
                <span class='n'>VLog</span><span class='p'>(</span><span class='s'>@&quot;Set %@.%@: %@&quot;</span><span class='p'>,</span> <span class='n'>NSStringFromClass</span><span class='p'>([</span><span class='n'>self</span> <span class='n'>class</span><span class='p'>]),</span> <span class='n'>key</span><span class='p'>,</span> <span class='n'>shortValue</span><span class='p'>);</span>
            <span class='p'>}</span> <span class='k'>else</span> <span class='p'>{</span>
                <span class='n'>VLog</span><span class='p'>(</span><span class='s'>@&quot;Warning: Did not set %@ to %@&quot;</span><span class='p'>,</span> <span class='n'>key</span><span class='p'>,</span> <span class='n'>shortValue</span><span class='p'>);</span>
            <span class='p'>}</span>

        <span class='p'>}</span>
        <span class='k'>@catch</span> <span class='p'>(</span><span class='n'>NSException</span> <span class='o'>*</span><span class='n'>exception</span><span class='p'>)</span> <span class='p'>{</span>
            <span class='n'>VLog</span><span class='p'>(</span><span class='s'>@&quot;Error with %@: %@&quot;</span><span class='p'>,</span> <span class='n'>key</span><span class='p'>,</span> <span class='n'>exception</span><span class='p'>.</span><span class='n'>debugDescription</span><span class='p'>);</span>
        <span class='p'>}</span>
        <span class='k'>@finally</span> <span class='p'>{</span>
            <span class='c1'>// nada</span>
        <span class='p'>}</span>

    <span class='p'>}</span>
    <span class='k'>return</span> <span class='n'>self</span><span class='p'>;</span>
<span class='p'>};</span>
</code></pre></div>
<p>Then in any class we&#8217;ve previously encoded:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='kt'>id</span><span class='p'>)</span><span class='nf'>initWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>aDecoder</span><span class='p'>{</span>
    <span class='n'>self</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>super</span> <span class='n'>init</span><span class='p'>];</span>
    <span class='p'>[</span><span class='n'>self</span> <span class='n'>LJD_initWithCoder</span><span class='o'>:</span><span class='n'>aDecoder</span><span class='p'>];</span>
    <span class='k'>return</span> <span class='n'>self</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>The logging is a little verbose, but it was helpful during development (and the macros ensure they won&#8217;t slow things down in production).</p>

<p>There&#8217;s a few downsides to this approach. While it&#8217;s mostly stable, we did run into crashes if a non <code>NSCoding</code> class sat inside a foundation class (like <code>NSArray</code> or <code>NSDictionary</code>). This mostly wasn&#8217;t a problem, since the crashes were all the result of something we missed, and a crash made it easy to fix during production (instead of silently failing).</p>

<p>The other downside is this bit of code:</p>
<div class='highlight'><pre><code class='objective-c'><span class='n'>NSString</span> <span class='o'>*</span><span class='n'>selectorName</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>NSString</span> <span class='n'>stringWithFormat</span><span class='o'>:</span><span class='s'>@&quot;set%@:&quot;</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>key</span> <span class='n'>stringByReplacingCharactersInRange</span><span class='o'>:</span><span class='n'>NSMakeRange</span><span class='p'>(</span><span class='mi'>0</span><span class='p'>,</span><span class='mi'>1</span><span class='p'>)</span> <span class='n'>withString</span><span class='o'>:</span><span class='p'>[[</span><span class='n'>key</span> <span class='n'>substringToIndex</span><span class='o'>:</span><span class='mi'>1</span><span class='p'>]</span> <span class='n'>capitalizedString</span><span class='p'>]]];</span>

<span class='k'>if</span> <span class='p'>(</span><span class='n'>value</span> <span class='o'>&amp;&amp;</span> <span class='n'>value</span> <span class='o'>!=</span> <span class='p'>[</span><span class='n'>NSNull</span> <span class='n'>null</span><span class='p'>]</span> <span class='o'>&amp;&amp;</span> <span class='p'>[</span><span class='n'>self</span> <span class='n'>respondsToSelector</span><span class='o'>:</span><span class='n'>NSSelectorFromString</span><span class='p'>(</span><span class='n'>selectorName</span><span class='p'>)])...</span>
</code></pre></div>
<p>This is checking if it&#8217;s a readonly property by looking for the selector <code>setValue:</code>. This is less than ideal, especially since you can declare custom setters for properties. However, I&#8217;ve never found a place where this is used in production code.</p>

<p>The last downside to this is side effects from calling <code>setValue:</code> type selectors. Many examples you see of NSCoding involve setting the instance variables inside of <code>initWithCoder:</code>, like so:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span> <span class='p'>(</span><span class='kt'>id</span><span class='p'>)</span><span class='nf'>initWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>decoder</span> <span class='p'>{</span>
    <span class='n'>self</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>super</span> <span class='n'>init</span><span class='p'>];</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='o'>!</span><span class='n'>self</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nb'>nil</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='n'>_title</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>decoder</span> <span class='n'>decodeObjectForKey</span><span class='o'>:</span><span class='s'>@&quot;title&quot;</span><span class='p'>];</span>
    <span class='n'>_author</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>decoder</span> <span class='n'>decodeObjectForKey</span><span class='o'>:</span><span class='s'>@&quot;author&quot;</span><span class='p'>];</span>
    <span class='n'>_pageCount</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>decoder</span> <span class='n'>decodeIntegerForKey</span><span class='o'>:</span><span class='s'>@&quot;pageCount&quot;</span><span class='p'>];</span>
    <span class='k'>return</span> <span class='n'>self</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>We had a great time trying to figure out why our final values didn&#8217;t match what we encoded, until we finally realized that some of the setter methods were setting other values in the class! That&#8217;s where the somewhat maniacal logging came into play. We ended up solving this by using a variant of this approach:</p>
<div class='highlight'><pre><code class='objective-c'><span class='k'>-</span><span class='p'>(</span><span class='kt'>id</span><span class='p'>)</span><span class='nf'>initWithCoder:</span><span class='p'>(</span><span class='n'>NSCoder</span> <span class='o'>*</span><span class='p'>)</span><span class='nv'>aDecoder</span> <span class='p'>{</span>
    <span class='n'>self</span> <span class='o'>=</span> <span class='p'>[</span><span class='n'>super</span> <span class='n'>init</span><span class='p'>];</span>
    <span class='n'>_doNotUpdate</span> <span class='o'>=</span> <span class='nb'>YES</span><span class='p'>;</span>
    <span class='p'>[</span><span class='n'>self</span> <span class='n'>agrianInitWithCoder</span><span class='o'>:</span><span class='n'>aDecoder</span><span class='p'>];</span>
    <span class='n'>_doNotUpdate</span> <span class='o'>=</span> <span class='nb'>NO</span><span class='p'>;</span>
    
    <span class='k'>return</span> <span class='n'>self</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>Any of our setter methods that had cascading effects all checked for <code>_doNotUpdate</code> before doing any changes.</p>

<h2 id='conclusion'>Conclusion</h2>

<p>I won&#8217;t go over <code>NSKeyedArchiver</code> or <code>NSKeyedUnarchiver</code> here. Those classes are very straightforward once we had all the encoding/decoding worked out.</p>

<p>We always strive for Good Code. Clean Code. Code that conforms to all the standards and conventions and unicorns out there. But that doesn&#8217;t always work out. Sometimes the Right Code is very dirty indeed. So don&#8217;t feel bad when you end up committing atrocities in the name of deadlines. We&#8217;ve all done it. Some of us even blog about it.</p>

      <a class="share" href="https://twitter.com/intent/tweet?text=&quot;Real World NSCoding&quot;%20/general/demo/sample/real_world_nscoding%20via%20&#64;lukedeniston" data-dnt="true">Share</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

      


      </article>

    </section>
</div>

<div class="push"></div>
  <footer>
    <aside class="wrap">
      <ol class="prev-posts">
        <p class="list-title">Recent Posts</p>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="/goodbye-objective-c" title="A Goodbye Letter to Objective-C">A Goodbye Letter to Objecti... </a></span>
              <span class="date">Jun 12, 2014</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="/general/demo/sample/real_world_nscoding" title="Real World NSCoding">Real World NSCoding </a></span>
              <span class="date">Nov 14, 2013</span>
            </li>
        
      </ol>

      <div class="social">
        <ul>
            <li><a id="mail" href="mailto:luke@lukedeniston.com"><span class="foot-link">Contact Me</span></a></li>

            
            <li><a id="twit" href="http://twitter.com/lukedeniston" target="_blank"><span class="foot-link">@lukedeniston</span></a></li>
            


            
        </ul>
    </div>
    </aside>
    <small>&copy; 2014 Luke Deniston. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://jekyll.gtat.me/about">Balzac</a> theme.</small>
  </footer>

  <!-- If they're out, get some from the cellar -->
  <script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="/assets/js/retina.min.js"></script>

  <!-- Custom JS -->
  <script src="/assets/js/scripts.js"></script>


  </body>
</html>

